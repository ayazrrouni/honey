<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Honeypot Dashboard</title>

    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<h1>üçØ Honeypot Dashboard</h1>

<div class="service-tabs">
    <button class="tab-btn active" data-service="SSH">SSH</button>
    <button class="tab-btn" data-service="FTP">FTP</button>
    <button class="tab-btn" data-service="HTTP">HTTP</button>
</div>

<div class="controls">
    <input
        type="text"
        id="searchInput"
        placeholder="Search IP..."
    >
    <button onclick="exportTable()">Export CSV</button>
</div>

{% if rows %}
<table id="honeypotTable">
    <thead>
        <tr>
            <th>Service</th>
            <th>IP Address</th>
            <th>Country</th>
            <th>Severity</th>
            <th>Sessions</th>
            <th>Commands</th>
            <th>Last Seen</th>
            <th>Last Commands</th>
        </tr>
    </thead>
    <tbody>
        {% for r in rows %}
        <tr class="service-row" data-service="{{ r.service }}">
            <td>{{ r.service }}</td>
            <td>{{ r.ip }}</td>
            <td>{{ r.country }}</td>
            <td>
                <span class="severity {{ r.severity|lower }}">
                    {{ r.severity }}
                </span>
            </td>
            <td>{{ r.sessions }}</td>
            <td>{{ r.commands }}</td>
            <td>{{ r.last_seen }}</td>
        <td>
    {% if r.last_commands %}
        {% for c in r.last_commands %}
            <div>{{ c }}</div>
        {% endfor %}
    {% else %}
        <div>-</div>
    {% endif %}
</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p class="empty">No data yet.</p>
{% endif %}

<!-- JS -->
<script src="{{ url_for('static', filename='dashboard.js') }}"></script>
<script>
    // Tab functionality
    const tabs = document.querySelectorAll('.tab-btn');
    const rows = document.querySelectorAll('.service-row');

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            // Switch active tab
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');

            const service = tab.dataset.service;
            rows.forEach(r => {
                r.style.display = (service === "ALL" || r.dataset.service === service) ? '' : 'none';
            });
        });
    });

    // Search filter
    document.getElementById("searchInput").addEventListener("keyup", function () {
        const filter = this.value.toLowerCase();
        rows.forEach(row => {
            const ip = row.cells[1].innerText.toLowerCase();
            row.style.display = ip.includes(filter) ? "" : "none";
        });
    });

    // Export CSV
    function exportTable() {
        let csv = [];
        const rowsAll = document.querySelectorAll("#honeypotTable tr");
        rowsAll.forEach(row => {
            let cols = row.querySelectorAll("td, th");
            let rowData = [];
            cols.forEach(col => {
                rowData.push('"' + col.innerText.replace(/"/g, '""') + '"');
            });
            csv.push(rowData.join(","));
        });

        const blob = new Blob([csv.join("\n")], { type: "text/csv" });
        const url = window.URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "honeypot_logs.csv";
        a.click();
    }
</script>

</body>
</html>
